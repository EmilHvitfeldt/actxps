---
output: github_document
editor_options: 
  chunk_output_type: inline
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# actxps

<!-- badges: start -->
[![R-CMD-check](https://github.com/mattheaphy/actxps/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/mattheaphy/actxps/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

The actxps package provides a set of tools to assist with the creation of 
actuarial experience studies.  Experience studies are used by actuaries to 
explore historical experience across blocks of business and to inform assumption
setting for projection models. 

- The `expose()` family of functions convert census-level records into policy 
or calendar year exposure records.
- The `exp_stats()` function creates experience summary data frames containing
observed claims, observed claim rates. Optionally, expected claim rates, 
actual-to-expected ratios, and limited fluctuation credibility estimates can
also be returned.
- The `autoplot()` and `autotable()` creates plots and tables for reporting.
- The `exp_shiny()` app launches a Shiny app that allows for interactive 
exploration of experience drivers.

## Installation

The actxps package can be installed from CRAN with:

``` r
install.packages("actxps")
```

To install the development version from [GitHub](https://github.com/) use:

``` r
devtools::install_github("mattheaphy/actxps")
```

## Basic usage

The `actxps` package includes a data frame containing simulated census data for 
a theoretical deferred annuity product with an optional guaranteed income rider. 
The grain of this data is one row per policy.

```{r, warning=FALSE}
library(actxps)
library(dplyr)

census_dat
```

Convert census records to exposure records with one row per policy per year.

```{r example}
exposed_data <- expose(census_dat, end_date = "2019-12-31", 
                        target_status = "Surrender")

exposed_data
```



Creates a summary of observed experience.

```{r}
exp_stats(exposed_data)
```

Using `dplyr::group_by`, create a summary grouped by policy year and the 
presence of a guaranteed income rider.

```{r}

exp_res <- exposed_data |> 
  group_by(pol_yr, inc_guar) |> 
  exp_stats()

exp_res
```

Calculate actual-to-expected ratios.

First, attach one or more columns of expected termination rates to the exposure
data. Then, pass these column names to the `expected` argument of `exp_stats`.

```{r}

expected_table <- c(seq(0.005, 0.03, length.out = 10), 0.2, 0.15, rep(0.05, 3))


exposed_data <- exposed_data |> 
  mutate(expected_1 = expected_table[pol_yr],
         expected_2 = ifelse(exposed_data$inc_guar, 0.015, 0.03))

exp_res <- exposed_data |> 
  group_by(pol_yr, inc_guar) |> 
  exp_stats(expected = c("expected_1", "expected_2"))

exp_res

```

Create visualizations using the `autoplot()` and `autotable()` functions.

```{r, warning=FALSE, message=FALSE, dpi = 400}

library(ggplot2)

.colors <- c("#eb15e4", "#7515eb")
theme_set(theme_light())

exp_res |> 
  autoplot() + 
  scale_color_manual(values = .colors) + 
  labs(title = "Observed Surrender Rates by Policy Year and Income Guarantee Presence")

```

```{r, eval = FALSE}
autotable(exp_res)
```

```{r, echo = FALSE}
autotable(exp_res) |> gt::gtsave(paste0(tempfile(), ".png"))
```

Launch a shiny app to interactively explore experience data.

```{r, eval = FALSE}
exp_shiny(exposed_data)
```

<img src="man/figures/exp_shiny.png" width="100%" />
